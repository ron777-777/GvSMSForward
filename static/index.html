<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>APPLE ID SMS查看器</title>
    <style>
        /* --- 基础样式 --- */
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: #f4f7f6;
            color: #333;
            margin: 0;
            padding: 20px;
            line-height: 1.6;
        }
        /* --- 容器 --- */
        #app-container {
            max-width: 800px;
            margin: 20px auto;
            background-color: #ffffff;
            border-radius: 10px;
            box-shadow: 0 6px 18px rgba(0,0,0,0.07);
            overflow: hidden; /* 确保子元素圆角 */
        }
        /* --- 顶部控制栏 --- */
        #controls {
            padding: 20px 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #eef;
            background-color: #fafcfe;
        }
        h1 { 
            color: #2c3e50;
            margin: 0;
            font-size: 1.5em;
        }
        button {
            background-color: #007aff;
            color: white;
            border: none;
            padding: 10px 16px;
            border-radius: 7px;
            cursor: pointer;
            font-size: 0.95em;
            font-weight: 500;
            transition: background-color 0.2s, box-shadow 0.2s;
        }
        button:hover {
            background-color: #0056b3;
            box-shadow: 0 4px 8px rgba(0,122,255,0.2);
        }
        /* --- 消息区域 --- */
        #messages-container {
            padding: 25px;
            max-height: 75vh;
            overflow-y: auto;
        }
        #status {
            font-style: italic;
            color: #888;
            font-size: 1em;
        }
        /* --- 单条消息卡片 --- */
        .message-card {
            background-color: #fdfdfd;
            border: 1px solid #e9e9e9;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.04);
            opacity: 0; /* 初始不可见，用于动画 */
            animation: fadeIn 0.5s ease forwards; /* 淡入动画 */
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .message-header {
            display: flex;
            justify-content: space-between;
            font-size: 0.9em;
            color: #555;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px dashed #f0f0f0;
        }
        .timestamp { color: #777; }
        .message-content {
            font-size: 1.05em;
            white-space: pre-wrap; /* 保留换行和空格 */
            word-wrap: break-word; /* 自动换行 */
        }
        /* --- 验证码高亮 --- */
        .message-content code {
            font-family: "Courier New", monospace;
            background-color: #fffbe6; /* 浅黄色背景 */
            color: #d9534f; /* 红色字体 */
            font-size: 1.25em; /* 更大更显眼 */
            font-weight: bold;
            padding: 3px 6px;
            border-radius: 5px;
            border: 1px solid #ffe58f;
        }
		.sender { 
    font-weight: bold; 
    color: #0056b3;
}
    </style>
</head>
<body>

    <div id="app-container">
        <div id="controls">
            <h1>APPLE ID SMS查看器</h1>
            <button id="refresh-btn">手动刷新</button>
        </div>

        <div id="messages-container">
            <span id="status">正在加载短信...</span>
            </div>
    </div>

<script>
            // ----------------------------------------------
            // ⚙️ [配置]
            // ----------------------------------------------
            const API_GET_URL = "/api/get-messages";
            // ----------------------------------------------


            // --- 脚本逻辑 ---

            // 获取 DOM 元素
            const messagesContainer = document.getElementById('messages-container');
            const statusElement = document.getElementById('status');
            const refreshButton = document.getElementById('refresh-btn');

            // [!!! 关键修改 1 !!!]
            // 我们需要一个变量来“记住”当前最新的短信时间戳
            let newestTimestamp = null;

            
            /**
             * 高亮显示短信中的潜在验证码 (例如 4 到 8 位的数字)
             */
            function highlightCodes(text) {
                return text.replace(/(\b\d{4,8}\b)/g, '<code>$1</code>');
            }


			/**
             * 格式化 ISO 8601 时间戳 (带日期)
             */
            function formatTime(isoString) {
                try {
                    const date = new Date(isoString);
                    
                    // [!!! 关键修改 !!!]
                    // 我们使用 toLocaleString (而不是 toLocaleTimeString)
                    // 并添加 'month' 和 'day' 选项
                    return date.toLocaleString('zh-CN', {
						year: '2-digit',
                        month: '2-digit',  // 月份 (e.g., 11)
                        day: '2-digit',    // 日期 (e.g., 13)
                        hour: '2-digit',   // 小时
                        minute: '2-digit', // 分钟
                        second: '2-digit', // 秒
                        hour12: false      // 确保24小时制
                    });
                } catch (e) {
                    console.error('时间格式化错误:', e);
                    return isoString; 
                }
            }
            
            /**
             * [!!! 关键修改 2 !!!]
             * 修改 fetchMessages 函数，使其具有“智能检查”功能
             */
            async function fetchMessages() {
                
                // 仅在初次加载时显示“正在刷新”
                if (document.getElementById('status')) {
                    statusElement.textContent = "正在刷新...";
                }

                try {
                    const response = await fetch(API_GET_URL);
                    if (!response.ok) {
                        throw new Error(`网络错误: ${response.status}`);
                    }

                    const messages = await response.json();

                    // [!!! 关键修复：在这里添加这一行 !!!]
                    // 无论后端顺序如何, 我们都在前端强制按时间倒序(最新的在最前)
                    // (b - a = 降序 = 最新的在最前)
                    messages.sort((a, b) => new Date(b.receivedAt) - new Date(a.receivedAt));


                    // --- 智能刷新逻辑开始 ---

                    if (messages.length === 0) {
                        // 如果服务器上没有消息
                        messagesContainer.innerHTML = '<span id="status">暂无短信。</span>';
                        newestTimestamp = null; // 重置时间戳
                        return;
                    }
                    
                    // 获取 API 返回的最新一条短信的时间戳
                    // (因为我们的 Python 代码使用 insert(0, ...), 所以最新的总是在第0个)
                    const apiNewestTimestamp = messages[0].receivedAt;

                    // [!!! 这就是停止闪烁的核心 !!!]
                    // 如果 API 返回的最新时间戳 和 我们“记住”的时间戳 相同
                    // 意味着没有新短信，我们什么都不做，直接退出函数。
                    if (apiNewestTimestamp === newestTimestamp) {
                        // console.log("没有新数据，不刷新DOM。"); // (您可以取消注释这行来调试)
                        return; 
                    }

                    // --- 智能刷新逻辑结束 ---

                    // [!!! 只有在“有新数据”时，才会执行到这里 !!!]
                    
                    console.log("检测到新数据，正在刷新页面...");
                    
                    // 更新我们“记住”的时间戳
                    newestTimestamp = apiNewestTimestamp; 
                    
                    // 清空容器 (现在这行代码只会在有新短信时才运行)
                    messagesContainer.innerHTML = ''; 

                    // 遍历数据并重新生成 HTML
                    messages.forEach(msg => {
                        const card = document.createElement('div');
                        card.className = 'message-card';

                        const safeContent = escapeHTML(msg.content);
                        const formattedContent = highlightCodes(safeContent);
                        const formattedTime = formatTime(msg.receivedAt);
                        const safeSender = escapeHTML(msg.sender);

                        card.innerHTML = `
                            <div class="message-header">
								<span class="sender">短信内容</span>  
                                <span class="timestamp">${formattedTime}</span>
                            </div>
                            <div class="message-content">${formattedContent}</div>
                        `;
                        messagesContainer.appendChild(card);
                    });

                } catch (error) {
                    console.error('获取短信失败:', error);
                    // 只有在容器为空时才显示错误
                    if (messagesContainer.innerHTML === '') {
                         messagesContainer.innerHTML = `<span id="status" style="color: red;">获取短信失败: ${error.message}</span>`;
                    }
                }
            }

            /**
            * 辅助函数：转义 HTML，防止 XSS 攻击
            */
            function escapeHTML(str) {
                if (!str) return '';
                return str.replace(/[&<>"']/g, function(m) {
                    return {'&': '&amp;','<': '&lt;','>': '&gt;','"': '&quot;',"'": '&#39;'}[m];
                });
            }

            // --- 事件监听 (保持不变) ---
            
            // 1. 页面加载时立即获取一次
            document.addEventListener('DOMContentLoaded', fetchMessages);
            
            // 2. 点击按钮时刷新
            // (我们强制刷新，清除旧的时间戳)
            refreshButton.addEventListener('click', () => {
                newestTimestamp = null; // 强制刷新
                fetchMessages();
            });

            // 3. (保持不变) 每 5 秒自动检查一次
            setInterval(fetchMessages, 5000); 

        </script>
    </body>
    </html>
</body>
</html>
